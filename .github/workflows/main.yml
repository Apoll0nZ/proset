name: Generate and upload PC news video

on:
  repository_dispatch:
    types: [generate_video]

jobs:
  render-and-upload:
    runs-on: ubuntu-latest

    env:
      MY_AWS_REGION: ${{ secrets.MY_AWS_REGION }}
      SCRIPT_S3_BUCKET: ${{ secrets.SCRIPT_S3_BUCKET }}
      SCRIPT_S3_PREFIX: ${{ secrets.SCRIPT_S3_PREFIX }}
      MY_DDB_TABLE_NAME: ${{ secrets.MY_DDB_TABLE_NAME }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRETS_JSON }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      VOICEVOX_API_URL: http://localhost:50021

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies (ffmpeg, imagemagick, playwright)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          # ImageMagickセキュリティポリシーを修正
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/g' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/area="[0-9]*[A-Z]*"/area="4GP"/g' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/width="[0-9]*[A-Z]*"/width="32KP"/g' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/height="[0-9]*[A-Z]*"/height="32KP"/g' /etc/ImageMagick-6/policy.xml
          pip install playwright
          playwright install chromium

      - name: Start VOICEVOX Docker engine
        run: |
          docker pull voicevox/voicevox_engine:cpu-ubuntu20.04-latest
          docker run -d \
            --name voicevox \
            -p 50021:50021 \
            voicevox/voicevox_engine:cpu-ubuntu20.04-latest
          
          # VOICEVOX API が起動するまで待機（ヘルスチェック付き）
          echo "Waiting for VOICEVOX API to be ready..."
          for i in {1..60}; do
            if curl -s -f http://localhost:50021/speakers > /dev/null 2>&1; then
              echo "VOICEVOX API is ready!"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          
          # 最終チェック
          if ! curl -s -f http://localhost:50021/speakers > /dev/null 2>&1; then
            echo "ERROR: VOICEVOX API failed to start after 120 seconds"
            docker logs voicevox
            exit 1
          fi

      - name: Install Python dependencies
        working-directory: ./video_engine
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug AWS secrets
        run: |
          echo "Checking AWS secrets..."
          echo "MY_AWS_REGION raw: '${{ secrets.MY_AWS_REGION }}'"
          echo "MY_AWS_REGION length: ${{ secrets.MY_AWS_REGION }}"
          echo "AWS_ACCESS_KEY_ID length: ${{ secrets.AWS_ACCESS_KEY_ID }}"
          echo "AWS_SECRET_ACCESS_KEY length: ${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          echo "AWS_ACCESS_KEY_ID starts with AKIA: ${{ startsWith(secrets.AWS_ACCESS_KEY_ID, 'AKIA') }}"
          echo "All secrets are non-empty: ${{ secrets.MY_AWS_REGION != '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Run video renderer
        working-directory: ./video_engine
        env:
          MY_AWS_REGION: ${{ secrets.MY_AWS_REGION }}
          MY_DDB_TABLE_NAME: ${{ secrets.MY_DDB_TABLE_NAME }}
          SCRIPT_S3_BUCKET: ${{ secrets.SCRIPT_S3_BUCKET }}
          SCRIPT_S3_PREFIX: ${{ secrets.SCRIPT_S3_PREFIX }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRETS_JSON }}
          YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python render_video.py \
            --s3-key "${{ github.event.client_payload.s3_key }}" \
            --s3-bucket "${{ github.event.client_payload.s3_bucket }}" \
            --content-hash "${{ github.event.client_payload.content_hash }}"

      - name: Check generated artifacts
        if: always()  # エラーが起きても実行
        run: |
          echo "=== Checking for generated artifacts ==="
          echo "Current directory: $(pwd)"
          echo "Repository root contents:"
          ls -lah ~/actions-runner/_work/youtube/youtube/ 2>/dev/null || ls -lah . 2>/dev/null || true
          echo ""
          echo "Checking for video.mp4:"
          [ -f "video.mp4" ] && echo "✓ video.mp4 found" || echo "✗ video.mp4 NOT found"
          [ -f "./video.mp4" ] && echo "✓ ./video.mp4 found" || echo "✗ ./video.mp4 NOT found"
          [ -f "../video.mp4" ] && echo "✓ ../video.mp4 found" || echo "✗ ../video.mp4 NOT found"
          echo ""
          echo "Checking for thumbnail.png:"
          [ -f "thumbnail.png" ] && echo "✓ thumbnail.png found" || echo "✗ thumbnail.png NOT found"
          [ -f "./thumbnail.png" ] && echo "✓ ./thumbnail.png found" || echo "✗ ./thumbnail.png NOT found"
          [ -f "../thumbnail.png" ] && echo "✓ ../thumbnail.png found" || echo "✗ ../thumbnail.png NOT found"

      - name: Upload Video Artifact
        if: always()  # エラーが起きても実行
        uses: actions/upload-artifact@v4
        with:
          name: debug-video-artifacts
          path: |
            debug-video-artifacts/video.mp4
            debug-video-artifacts/thumbnail.png
          retention-days: 1

      - name: Cleanup VOICEVOX container
        if: always()
        run: |
          docker stop voicevox || true
          docker rm voicevox || true
